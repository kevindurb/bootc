ARG FEDORA_MAJOR_VERSION=rawhide
FROM ghcr.io/kevindurb/gnome-bootc:${FEDORA_MAJOR_VERSION}

ADD https://pkg.surfacelinux.com/fedora/linux-surface.repo /etc/yum.repos.d/

ADD https://github.com/linux-surface/linux-surface/releases/download/silverblue-20201215-1/kernel-20201215-1.x86_64.rpm /tmp

RUN dnf remove -y \
  kernel-core \
  kernel-modules \
  kernel-modules-extra \
  libwacom \
  libwacom-data && \
  dnf install -y --allowerasing \
  /tmp/kernel-20201215-1.x86_64.rpm \
  kernel-surface \
  iptsd \
  libwacom-surface \
  surface-secureboot

RUN dnf install -y snapd && \
  systemctl enable snapd.service && \
  /usr/bin/ln -sf /var/lib/snapd/snap /

RUN dnf install -y tailscale && \
  systemctl enable tailscaled.service

RUN dnf install -y \
  gstreamer1-plugin-libav \
  gstreamer1-plugin-openh264 \
  gstreamer1-plugins-base \
  gstreamer1-plugins-good \
  heif-pixbuf-loader

RUN dnf install -y \
  gnome-shell-extension-gsconnect \
  gnome-shell-extension-caffeine \
  gnome-shell-extension-appindicator

RUN sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/bin

RUN dnf install -y syncthing && \
  systemctl --global enable syncthing.service

COPY ./scripts/dev-packages-install.sh /tmp
RUN /tmp/dev-packages-install.sh
