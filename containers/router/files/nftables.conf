#! /usr/sbin/nft -f

define wan = "eth1"
define lan = "eth0"
define lan_subnet_v4 = 192.168.0.0/16

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Fast-path good stuff / early drops
    ct state invalid drop
    ct state { established, related } accept

    iifname "lo" accept

    # Basic ICMP/ICMPv6 (rate-limit a bit, keep ND/PMTU healthy)
    ip protocol icmp limit rate 20/second burst 40 packets accept
    ip6 nexthdr ipv6-icmp limit rate 20/second burst 40 packets accept

    # Anti-spoof: never see RFC1918/etc on WAN ingress
    iifname $wan ip saddr { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 169.254.0.0/16, 127.0.0.0/8 } drop
    iifname $wan ip6 saddr { fc00::/7 } drop

    # WAN DHCP reply (if this box is a DHCP client on WAN)
    iifname $wan udp sport 67 udp dport 68 accept

    # SSH to router from LAN only (rate-limit new connections)
    iifname $lan tcp dport 22 ct state new limit rate 15/minute accept

    # dnsmasq on LAN (DNS + DHCPv4)
    iifname $lan udp dport {53,67} accept
    iifname $lan tcp dport 53 accept
  }

  chain forward {
    type filter hook forward priority 0; policy drop;

    ct state invalid drop
    ct state { established, related } accept

    # Only allow LAN subnet out to WAN
    iifname $lan ip saddr $lan_subnet_v4 oifname $wan accept

    # (Add port-forward exceptions here if needed)
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}

table ip nat {
  chain prerouting  { type nat hook prerouting  priority -100; }
  chain input       { type nat hook input       priority -100; }
  chain output      { type nat hook output      priority  100; }

  chain postrouting {
    type nat hook postrouting priority 100;
    oifname $wan masquerade
  }
}
