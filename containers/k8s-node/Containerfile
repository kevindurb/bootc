FROM ghcr.io/ublue-os/ucore:stable-nvidia@sha256:5ae3766a9dbf75d037fe3a6f01dab7894c9f998bec281f3bf4f4b329bd2e5953

ARG K3S_SELINUX_VERSION=1.6-1
RUN dnf install -y https://rpm.rancher.io/k3s/latest/common/centos/9/noarch/k3s-selinux-${K3S_SELINUX_VERSION}.el9.noarch.rpm && \
  dnf clean all

ARG FILES_ROOT=./containers/k8s-node/files
# renovate: datasource=github-tags depName=k3s packageName=k3s-io/k3s
ARG K3S_VERSION=v1.34.1+k3s1

COPY ${FILES_ROOT}/modules.conf /etc/modules-load.d/k8s.conf
COPY ${FILES_ROOT}/sysctl.conf /etc/sysctl.d/k8s.conf
COPY ${FILES_ROOT}/k3s-${K3S_VERSION} /usr/bin/k3s
COPY ${FILES_ROOT}/k3s.service /etc/systemd/system/
COPY ${FILES_ROOT}/k3s-agent.service /etc/systemd/system/
COPY ${FILES_ROOT}/sanoid.conf /etc/sanoid/
COPY ${FILES_ROOT}/rpm-ostreed.conf /etc/

RUN dnf remove -y \
  zram-generator-defaults && \
  systemctl disable firewalld && \
  systemctl enable tailscaled
